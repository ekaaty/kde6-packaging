From 584f806b9153976b5791e9b845411bda1fd818a4 Mon Sep 17 00:00:00 2001
From: Nicolas Fella <nicolas.fella@gmx.de>
Date: Wed, 8 Nov 2023 01:05:42 +0100
Subject: [PATCH] Enable building against Qt6

---
 .gitlab-ci.yml                                |  2 ++
 .kde-ci.yml                                   | 13 +++++++---
 CMakeLists.txt                                | 26 +++++++++++--------
 kaccounts/CMakeLists.txt                      |  9 +++----
 kaccounts/kaccountsplugin.cpp                 |  7 ++++-
 purpose/CMakeLists.txt                        |  6 ++---
 purpose/purpose_gdrive.cpp                    |  2 --
 src/CMakeLists.txt                            | 14 ++++++----
 .../contextmenuaction/CMakeLists.txt          |  5 ++--
 .../propertiesplugin/CMakeLists.txt           |  5 ++--
 src/kio_gdrive.cpp                            |  1 -
 11 files changed, 53 insertions(+), 37 deletions(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index f9680a1..694b5b8 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -4,3 +4,5 @@
 include:
   - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/linux.yml
   - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/freebsd.yml
+  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/linux-qt6.yml
+  - https://invent.kde.org/sysadmin/ci-utilities/raw/master/gitlab-templates/freebsd-qt6.yml
diff --git a/.kde-ci.yml b/.kde-ci.yml
index b9c5237..930a3a6 100644
--- a/.kde-ci.yml
+++ b/.kde-ci.yml
@@ -2,7 +2,7 @@
 # SPDX-License-Identifier: CC0-1.0
 
 Dependencies:
-- 'on': ['@all']
+- 'on': ['Linux/Qt5', 'FreeBSD/Qt5']
   'require':
     'frameworks/extra-cmake-modules': '@stable'
     'frameworks/ki18n': '@stable'
@@ -10,11 +10,18 @@ Dependencies:
     'frameworks/kio': '@stable'
     'frameworks/purpose': '@stable'
     'pim/libkgapi': '@stable'
+    'network/kaccounts-integration': '@same'
     'third-party/qtkeychain': '@latest'
 
-- 'on': ['Linux/Qt5', 'FreeBSD/Qt5']
+- 'on': ['Linux/Qt6', 'FreeBSD/Qt6']
   'require':
-    'network/kaccounts-integration': '@same'
+    'frameworks/extra-cmake-modules': '@latest-kf6'
+    'frameworks/ki18n': '@latest-kf6'
+    'frameworks/kdoctools': '@latest-kf6'
+    'frameworks/kio': '@latest-kf6'
+    'frameworks/purpose': '@latest-kf6'
+    'pim/libkgapi': '@latest-kf6'
+    'third-party/qtkeychain': '@latest'
 
 Options:
   require-passing-tests-on: [ 'Linux', 'FreeBSD' ]
diff --git a/CMakeLists.txt b/CMakeLists.txt
index 07f24ae..95fe7f8 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -8,12 +8,12 @@ set (RELEASE_SERVICE_VERSION "${RELEASE_SERVICE_VERSION_MAJOR}.${RELEASE_SERVICE
 project(kio-gdrive VERSION ${RELEASE_SERVICE_VERSION})
 
 set(QT_MIN_VERSION 5.15.2)
-set(KF5_MIN_VERSION 5.96.0)
+set(KF_MIN_VERSION 5.96.0)
 set(KGAPI_MIN_VERSION 5.11.41)
 set(KACCOUNTS_MIN_VERSION 20.03.80)
 set(QTKEYCHAIN_MIN_VERSION 0.6.0)
 
-find_package(ECM ${KF5_MIN_VERSION} REQUIRED NO_MODULE)
+find_package(ECM ${KF_MIN_VERSION} REQUIRED NO_MODULE)
 set(CMAKE_MODULE_PATH "${CMAKE_CURRENT_SOURCE_DIR}/cmake/modules" ${ECM_MODULE_PATH})
 
 include(FeatureSummary)
@@ -30,16 +30,20 @@ find_package(Qt${QT_MAJOR_VERSION} ${QT_MIN_VERSION} CONFIG REQUIRED COMPONENTS
     Widgets)
 
 
-find_package(KF5 ${KF5_MIN_VERSION} REQUIRED COMPONENTS
+find_package(KF${QT_MAJOR_VERSION} ${KF_MIN_VERSION} REQUIRED COMPONENTS
     I18n
     DocTools
     KIO)
 
-find_package(KPimGAPI ${KGAPI_MIN_VERSION} REQUIRED)
+if(QT_MAJOR_VERSION STREQUAL "5")
+    find_package(KPimGAPI ${KGAPI_MIN_VERSION} REQUIRED)
+else()
+    find_package(KPim6GAPI ${KGAPI_MIN_VERSION} REQUIRED)
+endif()
 
-find_package(KF5Purpose ${KF5_MIN_VERSION}) # Optional since it depends on KAccounts
+find_package(KF${QT_MAJOR_VERSION}Purpose ${KF_MIN_VERSION}) # Optional since it depends on KAccounts
 
-set_package_properties(KF5Purpose PROPERTIES TYPE RECOMMENDED PURPOSE "Enables the Share menu plugin.")
+set_package_properties(KF${QT_MAJOR_VERSION}Purpose PROPERTIES TYPE RECOMMENDED PURPOSE "Enables the Share menu plugin.")
 
 find_package(KAccounts ${KACCOUNTS_MIN_VERSION})
 set_package_properties(KAccounts PROPERTIES
@@ -49,18 +53,18 @@ set_package_properties(KAccounts PROPERTIES
 
 if (NOT KAccounts_FOUND)
     find_package(Qt${QT_MAJOR_VERSION}Keychain ${QTKEYCHAIN_MIN_VERSION} REQUIRED)
-    set_package_properties(Qt5Keychain PROPERTIES
+    set_package_properties(Qt${QT_MAJOR_VERSION}Keychain PROPERTIES
         URL "https://github.com/frankosterfeld/qtkeychain"
         PURPOSE "Required for secure storage of accounts secrets.")
     message(STATUS "Building the QtKeychain backend.")
 endif()
 
-find_package(Qt5Test QUIET)
-set_package_properties(Qt5Test PROPERTIES
+find_package(Qt${QT_MAJOR_VERSION}Test QUIET)
+set_package_properties(Qt${QT_MAJOR_VERSION}Test PROPERTIES
     TYPE OPTIONAL
     PURPOSE "Required for building tests.")
 
-if(NOT Qt5Test_FOUND)
+if(NOT Qt${QT_MAJOR_VERSION}Test_FOUND)
    set(BUILD_TESTING OFF CACHE BOOL "Build the testing tree.")
 endif()
 
@@ -83,7 +87,7 @@ add_subdirectory(desktop)
 add_subdirectory(doc)
 add_subdirectory(src)
 
-if (KF5Purpose_FOUND)
+if (KF${QT_MAJOR_VERSION}Purpose_FOUND)
     add_subdirectory(purpose)
 endif()
 
diff --git a/kaccounts/CMakeLists.txt b/kaccounts/CMakeLists.txt
index 8957661..555b42b 100644
--- a/kaccounts/CMakeLists.txt
+++ b/kaccounts/CMakeLists.txt
@@ -1,18 +1,17 @@
-find_package(KF5Notifications ${KF5_MIN_VERSION} REQUIRED)
+find_package(KF${QT_MAJOR_VERSION}Notifications ${KF_MIN_VERSION} REQUIRED)
 find_package(Intltool REQUIRED)
 
 kaccounts_add_service(${CMAKE_CURRENT_SOURCE_DIR}/google-drive.service.in)
 
 kcoreaddons_add_plugin(kaccounts_gdrive
-    JSON kaccountsplugin.json
     SOURCES kaccountsplugin.cpp
     INSTALL_NAMESPACE kaccounts/daemonplugins)
 
 set_target_properties(kaccounts_gdrive PROPERTIES OUTPUT_NAME "gdrive")
 target_link_libraries(kaccounts_gdrive
     KAccounts
-    KF5::KIOWidgets
-    KF5::I18n
-    KF5::Notifications)
+    KF${QT_MAJOR_VERSION}::KIOWidgets
+    KF${QT_MAJOR_VERSION}::I18n
+    KF${QT_MAJOR_VERSION}::Notifications)
 
 install(FILES gdrive.notifyrc DESTINATION ${KDE_INSTALL_KNOTIFYRCDIR})
diff --git a/kaccounts/kaccountsplugin.cpp b/kaccounts/kaccountsplugin.cpp
index e297ba9..676bc4a 100644
--- a/kaccounts/kaccountsplugin.cpp
+++ b/kaccounts/kaccountsplugin.cpp
@@ -35,13 +35,18 @@ void GoogleDrivePlugin::onAccountCreated(const Accounts::AccountId accountId, co
     notification->setComponentName(QStringLiteral("gdrive"));
     notification->setTitle(i18n("New Online Account"));
     notification->setText(xi18nc("@info", "You can now manage the Google Drive files of your <emphasis strong='true'>%1</emphasis> account.", account->displayName()));
-    notification->setActions({i18n("Open")});
 
     QUrl url;
     url.setScheme(QStringLiteral("gdrive"));
     url.setPath(QStringLiteral("/%1").arg(account->displayName()));
 
+#if QT_VERSION < QT_VERSION_CHECK(6, 0, 0)
+    notification->setActions({i18n("Open")});
     connect(notification, static_cast<void (KNotification::*)(unsigned int)>(&KNotification::activated), this, [=]() {
+#else
+    auto action = notification->addAction(i18n("Open"));
+    connect(action, &KNotificationAction::activated, this, [url] {
+#endif
         KIO::OpenUrlJob *job = new KIO::OpenUrlJob(url, QStringLiteral("inode/directory"));
         job->start();
     });
diff --git a/purpose/CMakeLists.txt b/purpose/CMakeLists.txt
index f77479d..af646d9 100644
--- a/purpose/CMakeLists.txt
+++ b/purpose/CMakeLists.txt
@@ -1,6 +1,6 @@
-kcoreaddons_add_plugin(purpose_gdrive SOURCES purpose_gdrive.cpp gdrivejob.cpp JSON "purpose_gdrive.json" INSTALL_NAMESPACE "kf${QT_MAJOR_VERSION}/purpose")
-target_link_libraries(purpose_gdrive Qt::Core KF5::Purpose)
+kcoreaddons_add_plugin(purpose_gdrive SOURCES purpose_gdrive.cpp gdrivejob.cpp INSTALL_NAMESPACE "kf${QT_MAJOR_VERSION}/purpose")
+target_link_libraries(purpose_gdrive Qt::Core KF${QT_MAJOR_VERSION}::Purpose)
 set_target_properties(purpose_gdrive PROPERTIES LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin/kf${QT_MAJOR_VERSION}/purpose")
 install(FILES "purpose_gdrive_config.qml" DESTINATION ${KDE_INSTALL_DATADIR}/purpose)
 
-target_link_libraries(purpose_gdrive KF5::KIOCore KF5::I18n KF5::Purpose)
+target_link_libraries(purpose_gdrive KF${QT_MAJOR_VERSION}::KIOCore KF${QT_MAJOR_VERSION}::I18n KF${QT_MAJOR_VERSION}::Purpose)
diff --git a/purpose/purpose_gdrive.cpp b/purpose/purpose_gdrive.cpp
index ff9a032..d491305 100644
--- a/purpose/purpose_gdrive.cpp
+++ b/purpose/purpose_gdrive.cpp
@@ -28,6 +28,4 @@ public:
 
 K_PLUGIN_CLASS_WITH_JSON(GDrivePlugin, "purpose_gdrive.json")
 
-EXPORT_SHARE_VERSION
-
 #include "purpose_gdrive.moc"
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 32828cb..3866ed9 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -37,11 +37,15 @@ kcoreaddons_add_plugin(kio_gdrive
 target_link_libraries(kio_gdrive
     Qt::Core
     Qt::Network
-    KPim::GAPICore
-    KPim::GAPIDrive
-    KF5::KIOCore
-    KF5::KIOWidgets
-    KF5::I18n
+    KF${QT_MAJOR_VERSION}::KIOCore
+    KF${QT_MAJOR_VERSION}::KIOWidgets
+    KF${QT_MAJOR_VERSION}::I18n
     ${BACKEND_LIBS})
 
+if(QT_MAJOR_VERSION STREQUAL "5")
+    target_link_libraries(kio_gdrive KPim::GAPICore KPim::GAPIDrive)
+else()
+    target_link_libraries(kio_gdrive KPim6::GAPICore KPim6::GAPIDrive)
+endif()
+
 set_target_properties(kio_gdrive PROPERTIES OUTPUT_NAME "gdrive")
diff --git a/src/integration/contextmenuaction/CMakeLists.txt b/src/integration/contextmenuaction/CMakeLists.txt
index d7aa336..faa38ad 100644
--- a/src/integration/contextmenuaction/CMakeLists.txt
+++ b/src/integration/contextmenuaction/CMakeLists.txt
@@ -1,8 +1,7 @@
 kcoreaddons_add_plugin(gdrivecontextmenuaction
     SOURCES contextmenuaction.cpp
-    JSON contextmenuaction.json
     INSTALL_NAMESPACE "kf${QT_MAJOR_VERSION}/kfileitemaction")
 
 target_link_libraries(gdrivecontextmenuaction
-    KF5::I18n
-    KF5::KIOWidgets)
+    KF${QT_MAJOR_VERSION}::I18n
+    KF${QT_MAJOR_VERSION}::KIOWidgets)
diff --git a/src/integration/propertiesplugin/CMakeLists.txt b/src/integration/propertiesplugin/CMakeLists.txt
index c766f87..bef4239 100644
--- a/src/integration/propertiesplugin/CMakeLists.txt
+++ b/src/integration/propertiesplugin/CMakeLists.txt
@@ -7,10 +7,9 @@ ki18n_wrap_ui(gdrivepropertiesplugin_SRCS gdrivepropertiesplugin.ui)
 
 kcoreaddons_add_plugin(gdrivepropertiesplugin
     SOURCES ${gdrivepropertiesplugin_SRCS}
-    JSON gdrivepropertiesplugin.json
     INSTALL_NAMESPACE "kf${QT_MAJOR_VERSION}/propertiesdialog")
 
 target_link_libraries(gdrivepropertiesplugin
-    KF5::I18n
-    KF5::KIOWidgets
+    KF${QT_MAJOR_VERSION}::I18n
+    KF${QT_MAJOR_VERSION}::KIOWidgets
 )
diff --git a/src/kio_gdrive.cpp b/src/kio_gdrive.cpp
index 6756c3a..c4cfd6b 100644
--- a/src/kio_gdrive.cpp
+++ b/src/kio_gdrive.cpp
@@ -42,7 +42,6 @@
 #include <KGAPI/Drive/FileTrashJob>
 #include <KGAPI/Drive/ParentReference>
 #include <KGAPI/Drive/Permission>
-#include <KIO/AccessManager>
 #include <KIO/Job>
 #include <KLocalizedString>
 
-- 
GitLab

