From e4701190d65f4d1559ded153e8d8307e46d507b1 Mon Sep 17 00:00:00 2001
From: Nicolas Fella <nicolas.fella@gmx.de>
Date: Mon, 4 Dec 2023 15:11:55 +0100
Subject: [PATCH] Fix using Qt6-based KAccounts

---
 CMakeLists.txt           | 14 ++++++++++----
 kaccounts/CMakeLists.txt |  2 +-
 src/CMakeLists.txt       |  4 ++--
 3 files changed, 13 insertions(+), 7 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 25c3bc9..bf96a18 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -45,13 +45,19 @@ find_package(KF${QT_MAJOR_VERSION}Purpose ${KF_MIN_VERSION}) # Optional since it
 
 set_package_properties(KF${QT_MAJOR_VERSION}Purpose PROPERTIES TYPE RECOMMENDED PURPOSE "Enables the Share menu plugin.")
 
-find_package(KAccounts ${KACCOUNTS_MIN_VERSION})
-set_package_properties(KAccounts PROPERTIES
+if(QT_MAJOR_VERSION STREQUAL "5")
+  set(KACCOUNTS_SUFFIX "")
+else()
+  set(KACCOUNTS_SUFFIX "6")
+endif()
+
+find_package(KAccounts${KACCOUNTS_SUFFIX} ${KACCOUNTS_MIN_VERSION})
+set_package_properties(KAccounts${KACCOUNTS_SUFFIX} PROPERTIES
     TYPE RECOMMENDED
     URL "https://commits.kde.org/kaccounts-integration"
     PURPOSE "Enables integration with system-wide accounts.")
 
-if (NOT KAccounts_FOUND)
+if (NOT KAccounts${KACCOUNTS_SUFFIX}_FOUND)
     find_package(Qt${QT_MAJOR_VERSION}Keychain ${QTKEYCHAIN_MIN_VERSION} REQUIRED)
     set_package_properties(Qt${QT_MAJOR_VERSION}Keychain PROPERTIES
         URL "https://github.com/frankosterfeld/qtkeychain"
@@ -91,7 +97,7 @@ if (KF${QT_MAJOR_VERSION}Purpose_FOUND)
     add_subdirectory(purpose)
 endif()
 
-if (KAccounts_FOUND)
+if (KAccounts${KACCOUNTS_SUFFIX}_FOUND)
     message(STATUS "Building the KAccounts backend.")
     add_subdirectory(kaccounts)
 endif()
diff --git a/kaccounts/CMakeLists.txt b/kaccounts/CMakeLists.txt
index 555b42b..7a923ac 100644
--- a/kaccounts/CMakeLists.txt
+++ b/kaccounts/CMakeLists.txt
@@ -9,7 +9,7 @@ kcoreaddons_add_plugin(kaccounts_gdrive
 
 set_target_properties(kaccounts_gdrive PROPERTIES OUTPUT_NAME "gdrive")
 target_link_libraries(kaccounts_gdrive
-    KAccounts
+    KAccounts${KACCOUNTS_SUFFIX}
     KF${QT_MAJOR_VERSION}::KIOWidgets
     KF${QT_MAJOR_VERSION}::I18n
     KF${QT_MAJOR_VERSION}::Notifications)
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 3866ed9..7f03cef 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -10,11 +10,11 @@ set(kio_gdrive_SRCS
     gdrivehelper.cpp
     gdriveurl.cpp)
 
-if (KAccounts_FOUND)
+if (KAccounts${KACCOUNTS_SUFFIX}_FOUND)
     set(BACKEND_SRC kaccountsmanager.cpp)
     set(BACKEND_HEADER kaccountsmanager.h)
     set(BACKEND_CLASSNAME KAccountsManager)
-    set(BACKEND_LIBS KAccounts)
+    set(BACKEND_LIBS KAccounts${KACCOUNTS_SUFFIX})
 else()
     set(BACKEND_SRC keychainaccountmanager.cpp)
     set(BACKEND_HEADER keychainaccountmanager.h)
-- 
GitLab

