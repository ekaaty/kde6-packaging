From e215b08323d3fade003c964fe1f8b6fc0a1111e6 Mon Sep 17 00:00:00 2001
From: Jonathan Esk-Riddell <jr@jriddell.org>
Date: Fri, 24 Nov 2023 15:37:52 +0000
Subject: [PATCH 1/2] update for kf6 ahead of megarelease 6.  make kf6 only. 
 drop presence to actually be a framework.  bump version to 0.8.0

---
 CMakeLists.txt                | 41 ++++++++++++++++-----------------
 KFKWeatherCoreConfig.cmake.in |  8 -------
 KWeatherCoreConfig.cmake.in   |  8 +++++++
 autotests/CMakeLists.txt      |  4 ++--
 src/CMakeLists.txt            | 43 +++++++++++++++++------------------
 5 files changed, 51 insertions(+), 53 deletions(-)
 delete mode 100644 KFKWeatherCoreConfig.cmake.in
 create mode 100644 KWeatherCoreConfig.cmake.in

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7d3d753..f1e9695 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -1,15 +1,15 @@
 cmake_minimum_required(VERSION 3.5)
-project(KWeatherCore VERSION "0.7.0")
+project(KWeatherCore VERSION "0.8.0")
 
 set(CMAKE_CXX_STANDARD 17)
 
 include(FeatureSummary)
 
-set(REQUIRED_QT_VERSION 5.12.0)
-set(KF_DEP_VERSION "5.75.0")
+set(REQUIRED_QT_VERSION 6.5.0)
+set(KF_DEP_VERSION "5.240.0")
 
 find_package(ECM ${KF_DEP_VERSION}  NO_MODULE)
-set_package_properties(ECM PROPERTIES TYPE REQUIRED DESCRIPTION "Extra CMake Modules." URL "https://commits.kde.org/extra-cmake-modules")
+set_package_properties(ECM PROPERTIES TYPE REQUIRED DESCRIPTION "Extra CMake Modules." URL "https://api.kde.org/ecm/")
 feature_summary(WHAT REQUIRED_PACKAGES_NOT_FOUND FATAL_ON_MISSING_REQUIRED_PACKAGES)
 
 set(CMAKE_MODULE_PATH ${ECM_MODULE_PATH})
@@ -31,14 +31,14 @@ add_feature_info(QCH ${BUILD_QCH} "API documentation in QCH format (for e.g. Qt
 
 ecm_setup_version(PROJECT VARIABLE_PREFIX KWEATHERCORE
                         VERSION_HEADER "${CMAKE_CURRENT_BINARY_DIR}/kweathercore_version.h"
-                        PACKAGE_VERSION_FILE "${CMAKE_CURRENT_BINARY_DIR}/KF${QT_MAJOR_VERSION}KWeatherCoreConfigVersion.cmake"
-                        SOVERSION 5)
+                        PACKAGE_VERSION_FILE "${CMAKE_CURRENT_BINARY_DIR}/KWeatherCoreConfigVersion.cmake"
+                        SOVERSION 6)
 
-find_package(Qt${QT_MAJOR_VERSION} ${REQUIRED_QT_VERSION} CONFIG REQUIRED Core Network Positioning)
-find_package(KF${QT_MAJOR_VERSION} ${KF_DEP_VERSION} REQUIRED COMPONENTS I18n Holidays)
+find_package(Qt6 ${REQUIRED_QT_VERSION} CONFIG REQUIRED Core Network Positioning)
+find_package(KF6 ${KF_DEP_VERSION} REQUIRED COMPONENTS I18n Holidays)
 
 
-add_definitions(-DTRANSLATION_DOMAIN=\"kweathercore5\")
+add_definitions(-DTRANSLATION_DOMAIN=\"kweathercore\")
 if (IS_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/po")
     ki18n_install(po)
 endif()
@@ -57,41 +57,40 @@ if(BUILD_EXAMPLES)
 endif()
 
 # create a Config.cmake and a ConfigVersion.cmake file and install them
-set(CMAKECONFIG_INSTALL_DIR "${KDE_INSTALL_CMAKEPACKAGEDIR}/KF${QT_MAJOR_VERSION}KWeatherCore")
+set(CMAKECONFIG_INSTALL_DIR "${KDE_INSTALL_CMAKEPACKAGEDIR}/KWeatherCore")
 
 if (BUILD_QCH)
     ecm_install_qch_export(
-        TARGETS KF${QT_MAJOR_VERSION}KWeatherCore_QCH
-        FILE KF${QT_MAJOR_VERSION}KWeatherCoreQchTargets.cmake
+        TARGETS KWeatherCore_QCH
+        FILE KWeatherCoreQchTargets.cmake
         DESTINATION "${CMAKECONFIG_INSTALL_DIR}"
         COMPONENT Devel
     )
-    set(PACKAGE_INCLUDE_QCHTARGETS "include(\"\${CMAKE_CURRENT_LIST_DIR}/KF${QT_MAJOR_VERSION}KWeatherCoreQchTargets.cmake\")")
+    set(PACKAGE_INCLUDE_QCHTARGETS "include(\"\${CMAKE_CURRENT_LIST_DIR}/KWeatherCoreQchTargets.cmake\")")
 endif()
 
 include(CMakePackageConfigHelpers)
 
 configure_package_config_file(
-    "${CMAKE_CURRENT_SOURCE_DIR}/KFKWeatherCoreConfig.cmake.in"
-    "${CMAKE_CURRENT_BINARY_DIR}/KF${QT_MAJOR_VERSION}KWeatherCoreConfig.cmake"
+    "${CMAKE_CURRENT_SOURCE_DIR}/KWeatherCoreConfig.cmake.in"
+    "${CMAKE_CURRENT_BINARY_DIR}/KWeatherCoreConfig.cmake"
     INSTALL_DESTINATION "${CMAKECONFIG_INSTALL_DIR}"
 )
 
 install(FILES
-            "${CMAKE_CURRENT_BINARY_DIR}/KF${QT_MAJOR_VERSION}KWeatherCoreConfig.cmake"
-            "${CMAKE_CURRENT_BINARY_DIR}/KF${QT_MAJOR_VERSION}KWeatherCoreConfigVersion.cmake"
+            "${CMAKE_CURRENT_BINARY_DIR}/KWeatherCoreConfig.cmake"
+            "${CMAKE_CURRENT_BINARY_DIR}/KWeatherCoreConfigVersion.cmake"
         DESTINATION "${CMAKECONFIG_INSTALL_DIR}"
         COMPONENT Devel
 )
 
-install(EXPORT KF${QT_MAJOR_VERSION}KWeatherCoreTargets
+install(EXPORT KWeatherCoreTargets
         DESTINATION "${CMAKECONFIG_INSTALL_DIR}"
-        FILE KF${QT_MAJOR_VERSION}KWeatherCoreTargets.cmake
-        NAMESPACE KF${QT_MAJOR_VERSION}::)
+        FILE KWeatherCoreTargets.cmake)
 
 install(FILES
     ${CMAKE_CURRENT_BINARY_DIR}/kweathercore_version.h
-    DESTINATION ${KDE_INSTALL_INCLUDEDIR_KF} COMPONENT Devel
+    DESTINATION ${KDE_INSTALL_INCLUDEDIR} COMPONENT Devel
 )
 
 feature_summary(WHAT ALL FATAL_ON_MISSING_REQUIRED_PACKAGES)
diff --git a/KFKWeatherCoreConfig.cmake.in b/KFKWeatherCoreConfig.cmake.in
deleted file mode 100644
index 0045730..0000000
--- a/KFKWeatherCoreConfig.cmake.in
+++ /dev/null
@@ -1,8 +0,0 @@
-@PACKAGE_INIT@
-
-include(CMakeFindDependencyMacro)
-find_dependency(Qt@QT_MAJOR_VERSION@Core @REQUIRED_QT_VERSION@)
-
-
-include("${CMAKE_CURRENT_LIST_DIR}/KF@QT_MAJOR_VERSION@KWeatherCoreTargets.cmake")
-@PACKAGE_INCLUDE_QCHTARGETS@
diff --git a/KWeatherCoreConfig.cmake.in b/KWeatherCoreConfig.cmake.in
new file mode 100644
index 0000000..7ddd3e8
--- /dev/null
+++ b/KWeatherCoreConfig.cmake.in
@@ -0,0 +1,8 @@
+@PACKAGE_INIT@
+
+include(CMakeFindDependencyMacro)
+find_dependency(Qt6Core @REQUIRED_QT_VERSION@)
+
+
+include("${CMAKE_CURRENT_LIST_DIR}/KWeatherCoreTargets.cmake")
+@PACKAGE_INCLUDE_QCHTARGETS@
diff --git a/autotests/CMakeLists.txt b/autotests/CMakeLists.txt
index d43ad79..4828429 100644
--- a/autotests/CMakeLists.txt
+++ b/autotests/CMakeLists.txt
@@ -13,7 +13,7 @@ ecm_add_tests(
     weatherforecasttest.cpp
     locationquerytest.cpp
     pendingweatherforecasttest.cpp
-    LINK_LIBRARIES KF${QT_MAJOR_VERSION}::KWeatherCore Qt${QT_MAJOR_VERSION}::Test
+    LINK_LIBRARIES KWeatherCore Qt6::Test
 )
 
-ecm_add_tests(geotimezonetest.cpp LINK_LIBRARIES KF${QT_MAJOR_VERSION}::KWeatherCore Qt${QT_MAJOR_VERSION}::Test Qt${QT_MAJOR_VERSION}::Network)
+ecm_add_tests(geotimezonetest.cpp LINK_LIBRARIES KWeatherCore Qt6::Test Qt6::Network)
diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index 434cefe..9b4369b 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -47,27 +47,26 @@ set(kweathercore_LIB_SRCS
 )
 
 
-add_library(KF${QT_MAJOR_VERSION}KWeatherCore ${kweathercore_LIB_SRCS})
-generate_export_header(KF${QT_MAJOR_VERSION}KWeatherCore BASE_NAME KWeatherCore EXPORT_FILE_NAME ${CMAKE_CURRENT_BINARY_DIR}/kweathercore/kweathercore_export.h)
-add_library(KF${QT_MAJOR_VERSION}::KWeatherCore ALIAS KF${QT_MAJOR_VERSION}KWeatherCore)
+add_library(KWeatherCore ${kweathercore_LIB_SRCS})
+generate_export_header(KWeatherCore BASE_NAME KWeatherCore EXPORT_FILE_NAME ${CMAKE_CURRENT_BINARY_DIR}/kweathercore/kweathercore_export.h)
 set(kweathercore_BUILD_INCLUDE_DIRS ${KWeatherCore_BINARY_DIR} ${CMAKE_CURRENT_BINARY_DIR})
-target_include_directories(KF${QT_MAJOR_VERSION}KWeatherCore PUBLIC "$<BUILD_INTERFACE:${kweathercore_BUILD_INCLUDE_DIRS}>")
-target_include_directories(KF${QT_MAJOR_VERSION}KWeatherCore INTERFACE "$<INSTALL_INTERFACE:${KDE_INSTALL_INCLUDEDIR_KF}/KWeatherCore>")
+target_include_directories(KWeatherCore PUBLIC "$<BUILD_INTERFACE:${kweathercore_BUILD_INCLUDE_DIRS}>")
+target_include_directories(KWeatherCore INTERFACE "$<INSTALL_INTERFACE:${KDE_INSTALL_INCLUDEDIR}/KWeatherCore>")
 
-target_link_libraries(KF${QT_MAJOR_VERSION}KWeatherCore
+target_link_libraries(KWeatherCore
 PUBLIC
-    Qt${QT_MAJOR_VERSION}::Core
+    Qt6::Core
 PRIVATE
-    Qt${QT_MAJOR_VERSION}::Network
-    Qt${QT_MAJOR_VERSION}::Positioning
-    KF${QT_MAJOR_VERSION}::I18n
-    KF${QT_MAJOR_VERSION}::I18nLocaleData
-    KF${QT_MAJOR_VERSION}::Holidays
+    Qt6::Network
+    Qt6::Positioning
+    KF6::I18n
+    KF6::I18nLocaleData
+    KF6::Holidays
 )
 
-set_target_properties(KF${QT_MAJOR_VERSION}KWeatherCore PROPERTIES VERSION ${KWEATHERCORE_VERSION_STRING}
-                                                 SOVERSION ${KWEATHERCORE_SOVERSION}
-                                                 EXPORT_NAME KWeatherCore
+set_target_properties(KWeatherCore PROPERTIES VERSION ${KWEATHERCORE_VERSION}
+                                   SOVERSION ${KWEATHERCORE_SOVERSION}
+                                   EXPORT_NAME KWeatherCore
 )
 
 ecm_generate_headers(KWeatherCore_CamelCase_HEADERS
@@ -96,20 +95,20 @@ ecm_generate_headers(KWeatherCore_CamelCase_HEADERS
     PREFIX KWeatherCore
     REQUIRED_HEADERS KWeatherCore_HEADERS
 )
-install(FILES ${KWeatherCore_CamelCase_HEADERS} DESTINATION ${KDE_INSTALL_INCLUDEDIR_KF}/KWeatherCore/KWeatherCore COMPONENT Devel)
+install(FILES ${KWeatherCore_CamelCase_HEADERS} DESTINATION ${KDE_INSTALL_INCLUDEDIR}/KWeatherCore/KWeatherCore COMPONENT Devel)
 
-install(TARGETS KF${QT_MAJOR_VERSION}KWeatherCore EXPORT KF${QT_MAJOR_VERSION}KWeatherCoreTargets ${KF_INSTALL_TARGETS_DEFAULT_ARGS})
+install(TARGETS KWeatherCore EXPORT KWeatherCoreTargets ${KDE_INSTALL_TARGETS_DEFAULT_ARGS})
 install(FILES
   ${CMAKE_CURRENT_BINARY_DIR}/kweathercore/kweathercore_export.h
   ${KWeatherCore_HEADERS}
-  DESTINATION ${KDE_INSTALL_INCLUDEDIR_KF}/KWeatherCore/kweathercore COMPONENT Devel
+  DESTINATION ${KDE_INSTALL_INCLUDEDIR}/KWeatherCore/kweathercore COMPONENT Devel
 )
 
 if(BUILD_QCH)
     ecm_add_qch(
-        KF${QT_MAJOR_VERSION}KWeatherCore_QCH
+        KWeatherCore_QCH
         NAME KWeatherCore
-        BASE_NAME KF${QT_MAJOR_VERSION}KWeatherCore
+        BASE_NAME KWeatherCore
         VERSION ${PROJECT_VERSION}
         ORG_DOMAIN org.kde
         SOURCES # using only public headers, to cover only public API
@@ -132,9 +131,9 @@ endif()
 include(ECMGeneratePriFile)
 ecm_generate_pri_file(
     BASE_NAME KWeatherCore
-    LIB_NAME KF${QT_MAJOR_VERSION}KWeatherCore
+    LIB_NAME KWeatherCore
     DEPS "core"
-    FILENAME_VAR PRI_FILENAME INCLUDE_INSTALL_DIR ${KDE_INSTALL_INCLUDEDIR_KF}/KWeatherCore
+    FILENAME_VAR PRI_FILENAME INCLUDE_INSTALL_DIR ${KDE_INSTALL_INCLUDEDIR}/KWeatherCore
 )
 install(FILES ${PRI_FILENAME}
         DESTINATION ${ECM_MKSPECS_INSTALL_DIR})
-- 
GitLab


From 15e798f2df04cd07f325745ba8afc8edbda519a6 Mon Sep 17 00:00:00 2001
From: Jonathan Esk-Riddell <jr@jriddell.org>
Date: Fri, 24 Nov 2023 15:56:18 +0000
Subject: [PATCH 2/2] remove qt5 jobs

---
 .gitlab-ci.yml | 4 ----
 1 file changed, 4 deletions(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index 9ea0ac4..dc1ea19 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -4,11 +4,7 @@
 include:
   - project: sysadmin/ci-utilities
     file:
-      - /gitlab-templates/linux.yml
       - /gitlab-templates/linux-qt6.yml
-      - /gitlab-templates/freebsd.yml
       - /gitlab-templates/freebsd-qt6.yml
-      - /gitlab-templates/android.yml
       - /gitlab-templates/android-qt6.yml
-      - /gitlab-templates/windows.yml
       - /gitlab-templates/windows-qt6.yml
-- 
GitLab

